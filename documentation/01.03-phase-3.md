# Phase 3: Backend Setup — Implementation Summary

## Overview

Set up the `@project/backend` workspace with Express, PostgreSQL, JWT authentication, Nunjucks view engine, and a layered architecture (routes → services → models).

## Files Created

### Package Configuration

| File | Purpose |
|------|---------|
| `backend/package.json` | Workspace package (`@project/backend`) with Express, pg, bcrypt, jsonwebtoken, nunjucks, cors, dotenv. Dev deps: tsx, vitest, TypeScript, type definitions. |
| `backend/tsconfig.json` | Extends root config. Sets `rootDir: "src"`, `outDir: "dist"`. No path aliases — imports shared package via workspace link (`@project/shared/*`). |

### Application Core

| File | Purpose |
|------|---------|
| `backend/src/app.ts` | Express app factory. Configures Nunjucks (`frontend/views/`), static files (`frontend/public/`), JSON/URL-encoded body parsing, CORS, route registration, and error handling middleware. |
| `backend/src/index.ts` | Entry point. Loads `dotenv/config`, starts HTTP server, handles graceful shutdown on SIGTERM/SIGINT with 10s forced exit timeout. |
| `backend/src/config.ts` | *(Phase 1 — unchanged)* Validates and exports typed config from environment variables. |

### Database

| File | Purpose |
|------|---------|
| `backend/src/db.ts` | PostgreSQL connection pool via `pg`. Exports `query<T>(text, params)`, `getClient()`, and `closePool()`. Parameterized queries only. |
| `backend/src/migrate.ts` | Migration runner. Creates `migrations` tracking table, applies `.sql` files from `backend/migrations/` in sorted order, skips already-applied. |
| `backend/migrations/001_initial.sql` | Users table (`id`, `email`, `name`, `password_hash`, `role`, `created_at`, `updated_at`), email index, and `update_updated_at` trigger. |

### Middleware

| File | Purpose |
|------|---------|
| `backend/src/middleware/auth.ts` | `authenticate` — extracts Bearer token, verifies JWT, attaches `req.user`. `generateToken` — signs JWT payload with configurable expiry. |
| `backend/src/middleware/validation.ts` | `validate(rules)` — declarative request body validation (required, type, minLength, maxLength, pattern). Returns 422 with joined error messages. |
| `backend/src/middleware/errorHandler.ts` | `AppError` class for typed HTTP errors. `notFoundHandler` — returns 404 JSON for `/api/*`, renders `pages/404.njk` otherwise. `errorHandler` — catch-all that logs and responds based on request path. |

### Services

| File | Purpose |
|------|---------|
| `backend/src/services/auth.ts` | `loginUser(email, password)` — finds user, compares bcrypt hash, returns token + user. `registerUser(email, name, password)` — checks for duplicates, hashes password, inserts user. `getUserById(id)` — returns user or undefined. |

### Routes

| File | Purpose |
|------|---------|
| `backend/src/routes/index.ts` | Aggregates page routes (`/`) and API routes (`/api/v1`). |
| `backend/src/routes/pages.ts` | `GET /` — renders `pages/index.njk` with title. |
| `backend/src/routes/api/v1/index.ts` | `POST /auth/login` — validates body + email format, calls `loginUser`. `POST /auth/register` — validates body (password min 8 chars), calls `registerUser`. `GET /users/me` — authenticated, returns current user. |

### Types

| File | Purpose |
|------|---------|
| `backend/src/types/express.d.ts` | Augments `Express.Request` with optional `user` property (`Omit<User, 'updatedAt'>`). |

### Testing

| File | Purpose |
|------|---------|
| `backend/vitest.config.ts` | Vitest config: Node environment, includes `tests/**/*.test.ts`, v8 coverage for `src/`. |
| `backend/tests/unit/example.test.ts` | 4 unit tests verifying shared constants (`HTTP_STATUS`, `USER_ROLES`) and shared utils (`isValidEmail`, `formatDate`). |
| `backend/tests/integration/api.test.ts` | Integration test scaffold (skipped). Documents setup steps for test database configuration. |

## Key Design Decisions

1. **Workspace imports over path aliases** — Backend imports `@project/shared/types` (resolved via npm workspace symlink) instead of `@shared/*` path aliases. This avoids TypeScript `rootDir` conflicts where shared source files would be pulled outside the backend's compilation root.

2. **App factory pattern** — `createApp()` returns a configured Express instance rather than exporting a singleton. This supports isolated testing (each test gets a fresh app) and avoids side effects at import time.

3. **Route → Service → Model layering** — Route handlers delegate to service functions, which own business logic and database access. Routes never call `query()` directly.

4. **Dual response modes** — Error handlers inspect `req.path` to decide between JSON (for `/api/*`) and rendered Nunjucks templates (for page routes). This supports the progressively enhanced MPA architecture.

5. **Migration runner** — Simple SQL-file-based migrations with a tracking table. No ORM dependency. Migrations are idempotent (uses `IF NOT EXISTS`).

6. **dotenv loaded at entry point** — `import 'dotenv/config'` runs only in `index.ts` (and `migrate.ts`), not in `config.ts`. This keeps the config module pure and avoids side effects when importing for tests.

## API Endpoints

| Method | Path | Auth | Description |
|--------|------|------|-------------|
| `POST` | `/api/v1/auth/login` | No | Authenticate with email/password, returns JWT |
| `POST` | `/api/v1/auth/register` | No | Create account, returns JWT |
| `GET` | `/api/v1/users/me` | Bearer | Returns authenticated user profile |

## Verification Results

| Command | Result |
|---------|--------|
| `npm run build:shared` | Compiles successfully |
| `npm run build:backend` | Compiles successfully |
| `npm run -w @project/backend test:unit` | 4 tests pass (191ms) |

## Integration Points

- **Shared package** — All type contracts (`User`, `LoginResponse`, `ApiErrorResponse`), constants (`HTTP_STATUS`, `USER_ROLES`), and utilities (`isValidEmail`) are imported from `@project/shared/*`.
- **Frontend views** — Express renders Nunjucks templates from `frontend/views/` and serves static assets from `frontend/public/`.
- **Database** — Requires PostgreSQL. Connection string from `DATABASE_URL` env var. Run `npm run -w @project/backend migrate` to apply schema.
